/*

    @file fir.c
    @author Eric Torres
    @email edt3@rice.edu
    @date 02/01/2021

    Made at Rice University, Go Owls!

      , _ ,
     ( o o )
    /'` ' `'\
    |'''''''|
    |\\'''//|
       """


    To-Do:
    - verify correctness of the data!
    - split it into multiple files for a testbench
    

*/


#include <stdio.h>
#include <string.h>

#include "fir.h"

#define FILTER_LENGTH 129
#define DATA_LENGTH 300

void fir(float* output_array_ptr, float* fir_coefs, int filter_length, int data_amt);

int check_if_equal(float* test_data, float* check_data, int data_length, float epsilon);

void print_array(float* arr_in, int size);

int main()
{

// 128th order filter
float b[129] = { 2.1804394561215686e-06, 7.307213539159978e-06, -3.827449953166632e-06, -1.4704540164019638e-05, 3.3367975113573343e-07, 2.8159131092762438e-05, 1.1167249741906437e-05, -4.416534273865827e-05, -3.661105503672574e-05, 5.733435304013607e-05, 8.078317610919384e-05, -5.763052084539841e-05, -0.0001453858201804361, 3.0666856104380794e-05, 0.0002258620282978998, 4.056900826626298e-05, -0.00030831882944288896, -0.00017203222519024828, 0.0003674277018298899, 0.00037300120240838105, -0.00036651161331593854, -0.0006392079118629813, 0.00026082827462677586, 0.0009459340394524694, -4.714989220599039e-06, -0.0012428881934381962, -0.0004375037249085257, 0.0014528732430846628, 0.0010778933037575956, -0.0014761146027485246, -0.0018906274832902327, 0.001201438616970056, 0.002799916832082243, -0.0005243490768165171, -0.0036733848501805328, -0.0006293437919894823, 0.004323894493194634, 0.002277193333147555, -0.004521857372400284, -0.004355041875733149, 0.004018432361160899, 0.006697649371843505, -0.002577981761373245, -0.009028932733824867, 1.6049239798177332e-05, 0.010964016532447503, 0.003762616934983964, -0.012022173026535866, -0.00873241393718241, 0.011644736846185128, 0.014727897127973032, -0.009203865740471018, -0.021442350947156043, 0.0039711052879326724, 0.028446433474786453, 0.005030229352636568, -0.035226192854648196, -0.019520876613283798, 0.04123651346991793, 0.043757133709014025, -0.04596309477471016, -0.09358118837624176, 0.048984251977186796, 0.31403596892799635, 0.44997659139669505, 0.31403596892799635, 0.048984251977186796, -0.09358118837624176, -0.04596309477471016, 0.043757133709014025, 0.04123651346991793, -0.019520876613283798, -0.035226192854648196, 0.005030229352636568, 0.028446433474786453, 0.0039711052879326724, -0.021442350947156043, -0.009203865740471018, 0.014727897127973032, 0.011644736846185128, -0.00873241393718241, -0.012022173026535866, 0.003762616934983964, 0.010964016532447503, 1.6049239798177332e-05, -0.009028932733824867, -0.002577981761373245, 0.006697649371843505, 0.004018432361160899, -0.004355041875733149, -0.004521857372400284, 0.002277193333147555, 0.004323894493194634, -0.0006293437919894823, -0.0036733848501805328, -0.0005243490768165171, 0.002799916832082243, 0.001201438616970056, -0.0018906274832902327, -0.0014761146027485246, 0.0010778933037575956, 0.0014528732430846628, -0.0004375037249085257, -0.0012428881934381962, -4.714989220599039e-06, 0.0009459340394524694, 0.00026082827462677586, -0.0006392079118629813, -0.00036651161331593854, 0.00037300120240838105, 0.0003674277018298899, -0.00017203222519024828, -0.00030831882944288896, 4.056900826626298e-05, 0.0002258620282978998, 3.0666856104380794e-05, -0.0001453858201804361, -5.763052084539841e-05, 8.078317610919384e-05, 5.733435304013607e-05, -3.661105503672574e-05, -4.416534273865827e-05, 1.1167249741906437e-05, 2.8159131092762438e-05, 3.3367975113573343e-07, -1.4704540164019638e-05, -3.827449953166632e-06, 7.307213539159978e-06, 2.1804394561215686e-06 };

float res[DATA_LENGTH];

fir(res, b, FILTER_LENGTH, DATA_LENGTH);

float true_res[] = {2.1804394561215686e-06, 7.307213539159978e-06, -3.827449953166632e-06, -1.4704540164019638e-05,
3.3367975113573343e-07, 2.8159131092762438e-05, 1.1167249741906437e-05, -4.416534273865827e-05, -3.661105503672574e-05,
5.733435304013607e-05, 8.078317610919384e-05, -5.763052084539841e-05, -0.0001453858201804361, 3.0666856104380794e-05,
0.0002258620282978998, 4.056900826626298e-05, -0.00030831882944288896, -0.00017203222519024828, 0.0003674277018298899,
0.00037300120240838105, -0.00036651161331593854, -0.0006392079118629813, 0.00026082827462677586, 0.0009459340394524694,
-4.714989220599039e-06, -0.0012428881934381962, -0.0004375037249085257, 0.0014528732430846628, 0.0010778933037575956,
-0.0014761146027485246, -0.0018906274832902327, 0.001201438616970056, 0.002799916832082243, -0.0005243490768165171,
-0.0036733848501805328, -0.0006293437919894823, 0.004323894493194634, 0.002277193333147555, -0.004521857372400284,
-0.004355041875733149, 0.004018432361160899, 0.006697649371843505, -0.002577981761373245, -0.009028932733824867,
1.6049239798177332e-05, 0.010964016532447503, 0.003762616934983964, -0.012022173026535866, -0.00873241393718241,
0.011644736846185128, 0.014727897127973032, -0.009203865740471018, -0.021442350947156043, 0.0039711052879326724,
0.028446433474786453, 0.005030229352636568, -0.035226192854648196, -0.019520876613283798, 0.04123651346991793,
0.043757133709014025, -0.04596309477471016, -0.09358118837624176, 0.048984251977186796, 0.31403596892799635,
0.44997659139669505, 0.31403596892799635, 0.048984251977186796, -0.09358118837624176, -0.04596309477471016,
0.043757133709014025, 0.04123651346991793, -0.019520876613283798, -0.035226192854648196, 0.005030229352636568,
0.028446433474786453, 0.0039711052879326724, -0.021442350947156043, -0.009203865740471018, 0.014727897127973032,
0.011644736846185128, -0.00873241393718241, -0.012022173026535866, 0.003762616934983964, 0.010964016532447503,
1.6049239798177332e-05, -0.009028932733824867, -0.002577981761373245, 0.006697649371843505, 0.004018432361160899,
-0.004355041875733149, -0.004521857372400284, 0.002277193333147555, 0.004323894493194634, -0.0006293437919894823,
-0.0036733848501805328, -0.0005243490768165171, 0.002799916832082243, 0.001201438616970056, -0.0018906274832902327,
-0.0014761146027485246, 0.0010778933037575956, 0.0014528732430846628, -0.0004375037249085257, -0.0012428881934381962,
-4.714989220599039e-06, 0.0009459340394524694, 0.00026082827462677586, -0.0006392079118629813, -0.00036651161331593854,
0.00037300120240838105, 0.0003674277018298899, -0.00017203222519024828, -0.00030831882944288896, 4.056900826626298e-05,
0.0002258620282978998, 3.0666856104380794e-05, -0.0001453858201804361, -5.763052084539841e-05, 8.078317610919384e-05,
5.733435304013607e-05, -3.661105503672574e-05, -4.416534273865827e-05, 1.1167249741906437e-05, 2.8159131092762438e-05,
3.3367975113573343e-07, -1.4704540164019638e-05, -3.827449953166632e-06, 7.307213539159978e-06, 2.1804394561215686e-06,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0};

print_array(res, DATA_LENGTH);

float epsilon = 2e-6;
int pass = check_if_equal(res, true_res, DATA_LENGTH, epsilon);

if (pass){
    printf("Test passed!");
}
else{
    printf("Test failed :(");
}


// initializing data (development purposes)
// float data[DATA_SIZE] = { 0.0 };
// data[0] = 1.0;
// data[134] = 1; // currently using an impulse to verify the impulse response

// calculating sizes for later use
// int data_size = sizeof data / sizeof data[0];
// int filter_size = sizeof b / sizeof b[0];

// float y_0[305]; // output, filtered data
    
// padding output/setting to zero, noticed inconsistencies in undefined arrays
// for (int i = 0; i < filter_size; i++){
//     y_0[i] = 0;
// }
    
    
// implementing filter for any size filter. data_size > filter_size
//  general concept of filter: y_0[i] = b[0] * data[i] + b[1] * data[i - 1] + b[2] * data[i - 2] + b[3] * data[i - 3] + ...;
// for (int i = filter_size; i < data_size; i++) {
//     float sum = 0;
//     for (int j = 0; j < filter_size; j++) {
//         sum += b[j] * data[i - j];
//     }
//     y_0[i] = sum;
// }

// printing both filtered data and original data
// print_array(&res[0], DATA_LENGTH);
// print_array(&data[0], DATA_LENGTH);

return 0;
}



void fir(float* output_array_ptr, float* fir_coefs, int filter_length, int data_amt){


    float padded_in[300] = {0.0};
    padded_in[filter_length] = 1.0;

    for (int i = filter_length; i < data_amt; i++) {
        float sum = 0;
        for (int j = 0; j < filter_length; j++) {
            sum += fir_coefs[j] * padded_in[i - j];
        }
        output_array_ptr[i-filter_length] = sum;
    }
}

int check_if_equal(float* test_data, float* check_data, int data_length, float epsilon){
    int match = 1;
    for (int i = 0; i < data_length; i++) {
        if ((*(test_data + i) < *(check_data + i) - epsilon) || (*(test_data + i) > * (check_data + i) + epsilon)) {
            match = 0;
        }
    }
    return match;    
}

void print_array(float* arr_in, int size)
{
    printf("{ ");
    for (int i = 0; i < size; i++) {
        printf("%f, ", *arr_in);
        arr_in++;
    }
    printf(" }\n");

}